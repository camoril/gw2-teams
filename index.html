<!--
    GW2 Teams ‚Äî WvW Roster & Squads
    Copyright (C) 2025 Ernesto Pineda Batalla (camoril)

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program. If not, see <https://www.gnu.org/licenses/>.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WvW Roster - Guild Wars 2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .gw2-brand {
            color: #00d4ff;
            font-weight: bold;
        }
        .form-card {
            background: rgba(45, 45, 45, 0.9);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .input-field {
            background: rgba(20, 20, 20, 0.7);
            border: 1px solid #555;
            color: #e0e0e0;
            padding: 10px 12px;
            border-radius: 6px;
            transition: border-color 0.3s;
        }
        .input-field:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.3);
        }
        .btn-primary {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: #000;
            font-weight: bold;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 212, 255, 0.4);
        }
        .btn-secondary {
            background: rgba(100, 100, 100, 0.8);
            color: #e0e0e0;
            padding: 10px 16px;
            border: 1px solid #666;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-secondary:hover {
            background: rgba(120, 120, 120, 0.9);
        }
        .btn-danger {
            background: rgba(220, 53, 69, 0.8);
            color: #fff;
            padding: 10px 16px;
            border: 1px solid #dc3545;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-danger:hover {
            background: rgba(200, 35, 51, 0.9);
        }
        .character-entry {
            background: rgba(35, 35, 35, 0.8);
            border-left: 4px solid #00d4ff;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 4px;
        }
        .character-entry:hover {
            background: rgba(40, 40, 40, 0.9);
        }
        .roster-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .roster-table th {
            background: rgba(0, 212, 255, 0.1);
            border-bottom: 2px solid #00d4ff;
            padding: 12px;
            text-align: left;
            color: #00d4ff;
        }
        .roster-table td {
            border-bottom: 1px solid #444;
            padding: 12px;
        }
        .roster-table tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
        }

        /* Tags style */
        .tag-pill {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 999px;
            font-size: 11px;
            background: rgba(0, 212, 255, 0.15);
            color: #a0e8ff;
            border: 1px solid rgba(0, 212, 255, 0.3);
            margin-right: 6px;
            margin-bottom: 4px;
        }

        /* Print-friendly adjustments */
        @media print {
            body {
                background: #fff !important;
                color: #000 !important;
            }
            .form-card, .roster-table, .badge, .tag-pill {
                box-shadow: none !important;
            }
            .btn-primary, .btn-secondary, button, input[type="file"] {
                display: none !important;
            }
            .form-card {
                background: #fff !important;
                border: 1px solid #ccc !important;
            }
        }
    </style>
</head>
<body>
    <div class="min-h-screen py-8 px-4">
        <div class="w-full max-w-[75%] mx-auto">
            <!-- Header -->
            <div class="text-center mb-12">
                <h1 class="text-5xl font-bold mb-2">
                    <span class="gw2-brand">WvW</span> Roster
                </h1>
                <p class="text-gray-400 text-lg">Guild Wars 2 World vs World Player Registration</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Form Section -->
                <div class="lg:col-span-2">
                    <div class="form-card">
                        <h2 class="text-2xl font-bold mb-6 gw2-brand">Add Character</h2>
                        
                        <form id="characterForm">
                            <!-- Player Name -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold mb-2">Player Name *</label>
                                <input 
                                    type="text" 
                                    id="playerName" 
                                    class="input-field w-full"
                                    placeholder="Your account name"
                                    required
                                >
                            </div>

                            <!-- Character Name -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold mb-2">Character Name *</label>
                                <input 
                                    type="text" 
                                    id="characterName" 
                                    class="input-field w-full"
                                    placeholder="Your character name"
                                    required
                                >
                            </div>

                            <!-- Role -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold mb-2">Role *</label>
                                <select id="role" class="input-field w-full" required>
                                    <option value="">Select a role</option>
                                    <option value="support-stab">Support (Stab/Aegis)</option>
                                    <option value="support-cleanse">Support (Cleanse/Heal)</option>
                                    <option value="dps-melee">DPS (Melee/Front)</option>
                                    <option value="dps-ranged">DPS (Ranged/Back)</option>
                                    <option value="dps-strip">DPS (Strip/Control)</option>
                                    <option value="roamer">Roamer / Havoc</option>
                                </select>
                            </div>

                            <!-- Subgroup -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold mb-2">Subgroup (1-15)</label>
                                <select id="subgroup" class="input-field w-full">
                                    <option value="1">Subgroup 1</option>
                                    <option value="2">Subgroup 2</option>
                                    <option value="3">Subgroup 3</option>
                                    <option value="4">Subgroup 4</option>
                                    <option value="5">Subgroup 5</option>
                                    <option value="6">Subgroup 6</option>
                                    <option value="7">Subgroup 7</option>
                                    <option value="8">Subgroup 8</option>
                                    <option value="9">Subgroup 9</option>
                                    <option value="10">Subgroup 10</option>
                                    <option value="11">Subgroup 11</option>
                                    <option value="12">Subgroup 12</option>
                                    <option value="13">Subgroup 13</option>
                                    <option value="14">Subgroup 14</option>
                                    <option value="15">Subgroup 15</option>
                                </select>
                            </div>

                            <!-- Class/Spec -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold mb-2">Class / Specialization *</label>
                                <select id="classSpec" class="input-field w-full" required>
                                    <option value="">Select a class</option>
                                    <!-- WARRIOR -->
                                    <optgroup label="Warrior">
                                        <option value="warrior">Warrior (Base)</option>
                                        <option value="warrior-berserker">Warrior - Berserker</option>
                                        <option value="warrior-spellbreaker">Warrior - Spellbreaker</option>
                                        <option value="warrior-bladesworn">Warrior - Bladesworn</option>
                                        <option value="warrior-paragon">Warrior - Paragon</option>
                                    </optgroup>
                                    <!-- GUARDIAN -->
                                    <optgroup label="Guardian">
                                        <option value="guardian">Guardian (Base)</option>
                                        <option value="guardian-dragonhunter">Guardian - Dragonhunter</option>
                                        <option value="guardian-firebrand">Guardian - Firebrand</option>
                                        <option value="guardian-willbender">Guardian - Willbender</option>
                                        <option value="guardian-luminary">Guardian - Luminary</option>
                                    </optgroup>
                                    <!-- REVENANT -->
                                    <optgroup label="Revenant">
                                        <option value="revenant">Revenant (Base)</option>
                                        <option value="revenant-herald">Revenant - Herald</option>
                                        <option value="revenant-renegade">Revenant - Renegade</option>
                                        <option value="revenant-vindicator">Revenant - Vindicator</option>
                                        <option value="revenant-conduit">Revenant - Conduit</option>
                                    </optgroup>
                                    <!-- RANGER -->
                                    <optgroup label="Ranger">
                                        <option value="ranger">Ranger (Base)</option>
                                        <option value="ranger-druid">Ranger - Druid</option>
                                        <option value="ranger-soulbeast">Ranger - Soulbeast</option>
                                        <option value="ranger-untamed">Ranger - Untamed</option>
                                        <option value="ranger-galeshot">Ranger - Galeshot</option>
                                    </optgroup>
                                    <!-- ENGINEER -->
                                    <optgroup label="Engineer">
                                        <option value="engineer">Engineer (Base)</option>
                                        <option value="engineer-scrapper">Engineer - Scrapper</option>
                                        <option value="engineer-holosmith">Engineer - Holosmith</option>
                                        <option value="engineer-mechanist">Engineer - Mechanist</option>
                                        <option value="engineer-amalgam">Engineer - Amalgam</option>
                                    </optgroup>
                                    <!-- THIEF -->
                                    <optgroup label="Thief">
                                        <option value="thief">Thief (Base)</option>
                                        <option value="thief-daredevil">Thief - Daredevil</option>
                                        <option value="thief-deadeye">Thief - Deadeye</option>
                                        <option value="thief-specter">Thief - Specter</option>
                                        <option value="thief-antiquary">Thief - Antiquary</option>
                                    </optgroup>
                                    <!-- ELEMENTALIST -->
                                    <optgroup label="Elementalist">
                                        <option value="elementalist">Elementalist (Base)</option>
                                        <option value="elementalist-tempest">Elementalist - Tempest</option>
                                        <option value="elementalist-weaver">Elementalist - Weaver</option>
                                        <option value="elementalist-catalyst">Elementalist - Catalyst</option>
                                        <option value="elementalist-evoker">Elementalist - Evoker</option>
                                    </optgroup>
                                    <!-- MESMER -->
                                    <optgroup label="Mesmer">
                                        <option value="mesmer">Mesmer (Base)</option>
                                        <option value="mesmer-chronomancer">Mesmer - Chronomancer</option>
                                        <option value="mesmer-mirage">Mesmer - Mirage</option>
                                        <option value="mesmer-virtuoso">Mesmer - Virtuoso</option>
                                        <option value="mesmer-troubadour">Mesmer - Troubadour</option>
                                    </optgroup>
                                    <!-- NECROMANCER -->
                                    <optgroup label="Necromancer">
                                        <option value="necromancer">Necromancer (Base)</option>
                                        <option value="necromancer-reaper">Necromancer - Reaper</option>
                                        <option value="necromancer-scourge">Necromancer - Scourge</option>
                                        <option value="necromancer-harbinger">Necromancer - Harbinger</option>
                                        <option value="necromancer-ritualist">Necromancer - Ritualist</option>
                                    </optgroup>
                                </select>
                            </div>

                            <!-- Gear -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold mb-2">Gear / Build Quality *</label>
                                <select id="gear" class="input-field w-full" required>
                                    <option value="">Select gear quality</option>
                                    <option value="legendary">Legendary</option>
                                    <option value="ascended">Ascended</option>
                                    <option value="exotic">Exotic</option>
                                    <option value="rare">Rare</option>
                                    <option value="mixed">Mixed / Leveling</option>
                                </select>
                            </div>

                            <!-- Notes -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold mb-2">Notes (Optional)</label>
                                <textarea 
                                    id="notes" 
                                    class="input-field w-full"
                                    placeholder="Any additional info about your character (weapon preferences, experience level, etc.)"
                                    rows="4"
                                ></textarea>
                            </div>

                            <!-- Tags -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold mb-2">Tags (comma-separated, optional)</label>
                                <input 
                                    type="text" 
                                    id="tags" 
                                    class="input-field w-full"
                                    placeholder="commander, backup, flex"
                                >
                            </div>

                            <!-- Build Link -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold mb-2">Build Link (Optional)</label>
                                <input 
                                    type="url" 
                                    id="buildLink" 
                                    class="input-field w-full"
                                    placeholder="https://gw2skills.net/editor/..."
                                >
                            </div>

                            <!-- Buttons -->
                            <div class="flex gap-4">
                                <button type="submit" class="btn-primary">Add Character</button>
                                <button type="reset" class="btn-secondary">Clear Form</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Stats Section -->
                <div>
                    <div class="form-card">
                        <h2 class="text-xl font-bold mb-4 gw2-brand">Team Statistics</h2>
                        <div class="space-y-4">
                            <div>
                                <p class="text-gray-400 text-sm">Total Players</p>
                                <p class="text-3xl font-bold gw2-brand" id="totalPlayers">0</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-sm">Total Characters</p>
                                <p class="text-3xl font-bold gw2-brand" id="totalCharacters">0</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-sm">Most Common Role</p>
                                <p class="text-xl font-bold gw2-brand" id="commonRole">-</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-sm">Most Used Class</p>
                                <p class="text-xl font-bold gw2-brand" id="commonClass">-</p>
                            </div>
                        </div>

                        <div class="mt-6 pt-4 border-t border-gray-700">
                            <div class="flex flex-wrap items-center gap-2 mb-3 justify-between">
                                <h3 class="text-lg font-bold text-gray-200">Role Targets</h3>
                                <div class="flex flex-wrap items-center gap-2">
                                    <select id="rolePresetSelect" class="input-field text-sm" aria-label="Role preset">
                                        <option value="">Select preset</option>
                                    </select>
                                    <button id="applyRolePresetBtn" class="btn-secondary text-sm">Apply Preset</button>
                                    <button id="clearRolePresetBtn" class="btn-secondary text-sm">Clear Presets</button>
                                    <button id="saveRoleTargetsBtn" class="btn-secondary text-sm">Save Targets</button>
                                </div>
                            </div>
                            <div id="roleTargetsContainer" class="space-y-2 text-sm text-gray-200"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Boons Information Panel -->
            <div class="mt-12">
                <div class="form-card">
                    <h2 class="text-2xl font-bold mb-6 gw2-brand">Team Boons Analysis</h2>
                    <p class="text-gray-400 text-sm mb-6">Boons provided by characters in your roster</p>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Roster Boons -->
                        <div>
                            <h3 class="text-lg font-bold text-gray-300 mb-4">üìä All Team Boons</h3>
                            <div id="teamBoonDisplay" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
                            <div id="emptyRosterMessage" class="text-center py-6 text-gray-500">
                                No characters in roster yet. Add characters to see team boons.
                            </div>
                        </div>
                        
                        <!-- Boon Uptime Summary -->
                        <div>
                            <h3 class="text-lg font-bold text-gray-300 mb-4">‚ö° Boon Coverage</h3>
                            <div id="boonCoverageDisplay" class="space-y-2"></div>
                        </div>
                    </div>
                    
                    <!-- Individual Class Viewer & Boon Search -->
                    <div class="mt-8 pt-6 border-t border-gray-700 grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Inspect Boons by Profession -->
                        <div>
                            <h3 class="text-lg font-bold text-gray-300 mb-4">üîç Inspect Boons by Profession</h3>
                            <div class="mb-4 flex gap-2">
                                <select id="boonClassSelect" class="input-field w-full">
                                    <option value="">-- Select Profession/Spec to inspect --</option>
                                </select>
                                <button id="addGenericBtn" class="btn-primary whitespace-nowrap" style="display: none;">Add Generic</button>
                            </div>
                            <div id="boonDisplayArea" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                        </div>

                        <!-- Find Professions by Boon -->
                        <div>
                            <h3 class="text-lg font-bold text-gray-300 mb-4">üîé Find Professions by Boon</h3>
                            <div class="mb-4">
                                <select id="boonFilterSelect" class="input-field w-full">
                                    <option value="">-- Select Boon to find Professions --</option>
                                </select>
                            </div>
                            <div id="classesByBoonDisplay" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Roster Table -->
            <div class="mt-12">
                <div class="form-card">
                    <h2 class="text-2xl font-bold mb-6 gw2-brand">Team Roster</h2>

                    <!-- Subgroup Analysis -->
                    <div id="subgroupAnalysis" class="mb-8">
                        <h3 class="text-lg font-bold text-gray-300 mb-4">üõ°Ô∏è Subgroup Composition & Boons</h3>
                        <div id="subgroupGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            <!-- Subgroup cards will be injected here -->
                        </div>
                    </div>

                    <!-- Filters and Sorting -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="space-y-2">
                            <input id="filterSearch" class="input-field w-full" type="text" placeholder="Search player / character / notes" aria-label="Search roster" />
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                <select id="filterRole" class="input-field w-full" aria-label="Filter by role">
                                    <option value="">All roles</option>
                                    <option value="support-stab">Support (Stab/Aegis)</option>
                                    <option value="support-cleanse">Support (Cleanse/Heal)</option>
                                    <option value="dps-melee">DPS (Melee/Front)</option>
                                    <option value="dps-ranged">DPS (Ranged/Back)</option>
                                    <option value="dps-strip">DPS (Strip/Control)</option>
                                    <option value="roamer">Roamer / Havoc</option>
                                </select>
                                <select id="filterGear" class="input-field w-full" aria-label="Filter by gear">
                                    <option value="">All gear</option>
                                    <option value="legendary">Legendary</option>
                                    <option value="ascended">Ascended</option>
                                    <option value="exotic">Exotic</option>
                                    <option value="rare">Rare</option>
                                    <option value="mixed">Mixed / Leveling</option>
                                </select>
                                <input id="filterTag" class="input-field w-full" type="text" placeholder="Filter by tag" aria-label="Filter by tag" />
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <label class="text-sm text-gray-400" for="sortField">Sort</label>
                                <select id="sortField" class="input-field w-full" aria-label="Sort field">
                                    <option value="playerName">Player</option>
                                    <option value="characterName">Character</option>
                                    <option value="role">Role</option>
                                    <option value="classSpec">Class / Spec</option>
                                    <option value="gear">Gear</option>
                                </select>
                                <button id="sortDirectionBtn" class="btn-secondary" aria-label="Toggle sort direction">Asc</button>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <button id="applyFiltersBtn" class="btn-primary">Apply Filters</button>
                                <button id="clearFiltersBtn" class="btn-secondary">Clear</button>
                                <button id="exportCsvBtn" class="btn-secondary">Export Filtered (CSV)</button>
                                <button id="exportFilteredJsonBtn" class="btn-secondary">Export Filtered (JSON)</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="roster-table" id="rosterTable">
                            <thead>
                                <tr>
                                    <th>Sub</th>
                                    <th>Player</th>
                                    <th>Character</th>
                                    <th>Role</th>
                                    <th>Class / Spec</th>
                                    <th>Gear</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="rosterBody">
                                <tr>
                                    <td colspan="8" class="text-center py-8 text-gray-500">
                                        No characters registered yet. Add your first character above!
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Export Section -->
            <div class="mt-8 text-center space-y-4">
                <div>
                    <button id="exportBtn" class="btn-primary">Export Roster (JSON)</button>
                    <button id="importBtn" class="btn-secondary ml-4">Import to Roster</button>
                    <input type="file" id="importFile" accept=".json" style="display:none;">
                    <button id="clearRosterBtn" class="btn-danger ml-4">Reset Roster</button>
                </div>
                <div>
                    <button id="importSquadBtn" class="btn-secondary">Import as Squad</button>
                    <input type="file" id="importSquadFile" accept=".json" style="display:none;">
                    <button id="manageSquadsBtn" class="btn-secondary ml-4">Manage Squads</button>
                </div>
            </div>

            <!-- Squads Management Modal -->
            <div id="squadsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;">
                <div style="max-width: 900px; margin: 40px auto; background: #2d2d2d; border-radius: 12px; padding: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 class="text-2xl font-bold gw2-brand">Manage Squads</h2>
                        <button id="closeSquadsModal" style="background: #666; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer;">Close</button>
                    </div>
                    <div id="squadsListContainer"></div>
                    <div id="squadAnalyticsPanel" class="mt-6" style="background: rgba(0,0,0,0.25); border: 1px solid #444; border-radius: 8px; padding: 16px; display: none;">
                        <h3 class="text-lg font-bold gw2-brand mb-2">Squad Analytics</h3>
                        <div id="squadAnalyticsContent" class="space-y-3 text-sm text-gray-200"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Add Modal -->
    <div id="quickAddModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg w-96 border border-gray-600">
            <h3 id="quickAddTitle" class="text-xl font-bold text-white mb-4">Quick Add Character</h3>
            
            <div class="mb-4">
                <label class="block text-gray-300 text-sm font-bold mb-2">Profession / Spec</label>
                <select id="quickAddSpec" class="input-field w-full">
                    <!-- Populated by JS -->
                </select>
            </div>

            <div class="mb-6">
                <label class="block text-gray-300 text-sm font-bold mb-2">Subgroup</label>
                <select id="quickAddSubgroup" class="input-field w-full">
                    <option value="1">Subgroup 1</option>
                    <option value="2">Subgroup 2</option>
                    <option value="3">Subgroup 3</option>
                    <option value="4">Subgroup 4</option>
                    <option value="5">Subgroup 5</option>
                    <option value="6">Subgroup 6</option>
                    <option value="7">Subgroup 7</option>
                    <option value="8">Subgroup 8</option>
                    <option value="9">Subgroup 9</option>
                    <option value="10">Subgroup 10</option>
                    <option value="11">Subgroup 11</option>
                    <option value="12">Subgroup 12</option>
                    <option value="13">Subgroup 13</option>
                    <option value="14">Subgroup 14</option>
                    <option value="15">Subgroup 15</option>
                </select>
            </div>

            <div class="flex justify-end gap-2">
                <button onclick="closeQuickAddModal()" class="btn-secondary">Cancel</button>
                <button onclick="confirmQuickAdd()" class="btn-primary">Add Character</button>
            </div>
        </div>
    </div>

    <script>
        // Allowed values
        const allowedRoles = [
            "support-stab", "support-cleanse", "dps-melee", "dps-ranged", "dps-strip", "roamer"
        ];
        const allowedGear = ["legendary", "ascended", "exotic", "rare", "mixed"];
        const roleLabels = {
            "support-stab": "Support (Stab/Aegis)",
            "support-cleanse": "Support (Cleanse/Heal)",
            "dps-melee": "DPS (Melee/Front)",
            "dps-ranged": "DPS (Ranged/Back)",
            "dps-strip": "DPS (Strip/Control)",
            "roamer": "Roamer / Havoc"
        };
        const rolePresets = {
            "zerg-30": {
                label: "Zerg 30",
                description: "Standard 30-man Zerg composition.",
                targets: {
                    "support-stab": 6,
                    "support-cleanse": 6,
                    "dps-melee": 10,
                    "dps-ranged": 4,
                    "dps-strip": 4,
                    "roamer": 0
                }
            },
            "strike-10": {
                label: "Strike 10",
                description: "Standard 10-man Strike Mission composition.",
                targets: {
                    "support-stab": 2,
                    "support-cleanse": 2,
                    "dps-melee": 4,
                    "dps-ranged": 2,
                    "dps-strip": 0,
                    "roamer": 0
                }
            },
            "gvg-15": {
                label: "GvG 15",
                description: "Standard GvG composition focused on balanced parties.",
                targets: {
                    "support-stab": 3,
                    "support-cleanse": 3,
                    "dps-melee": 6,
                    "dps-ranged": 2,
                    "dps-strip": 1,
                    "roamer": 0
                }
            },
            "minstrel-blob-50": {
                label: "Minstrel Blob (50)",
                description: "Stacks of supportive healers (Minstrel Firebrands, Tempests) overwhelming enemies with sustain, strong against direct fights but slow on objectives.",
                targets: {
                    "support-stab": 12,
                    "support-cleanse": 12,
                    "dps-melee": 16,
                    "dps-ranged": 5,
                    "dps-strip": 5,
                    "roamer": 0
                }
            },
            "boon-ball-30": {
                label: "Boon Ball (30)",
                description: "Focuses on high boon uptime (Quickness, Alacrity, Stability, Protection) for massive damage and defense.",
                targets: {
                    "support-stab": 8,
                    "support-cleanse": 4,
                    "dps-melee": 14,
                    "dps-ranged": 2,
                    "dps-strip": 2,
                    "roamer": 0
                }
            },
            "zerg-busting-20": {
                label: "Zerg Busting (20)",
                description: "Mix of high burst, CC, and boon ripping to disrupt large groups.",
                targets: {
                    "support-stab": 4,
                    "support-cleanse": 4,
                    "dps-melee": 8,
                    "dps-ranged": 2,
                    "dps-strip": 2,
                    "roamer": 0
                }
            }
        };

        // Boons Database - What boons can each class/spec provide
        const boonsByClass = {
            "guardian": ["Aegis", "Protection", "Regeneration", "Resistance"],
            "guardian-dragonhunter": ["Aegis", "Protection", "Regeneration", "Resistance", "Vigor"],
            "guardian-firebrand": ["Might", "Vigor", "Regeneration", "Stability", "Protection", "Resolution"],
            "guardian-willbender": ["Might", "Vigor", "Regeneration", "Stability", "Protection", "Quickness"],
            "guardian-luminary": ["Might", "Vigor", "Regeneration", "Protection", "Stability", "Alacrity"],
            "revenant": ["Might", "Regeneration", "Protection", "Resistance"],
            "revenant-herald": ["Might", "Regeneration", "Protection", "Resistance", "Vigor", "Swiftness"],
            "revenant-renegade": ["Might", "Alacrity", "Quickness", "Regeneration", "Swiftness"],
            "revenant-vindicator": ["Might", "Fury", "Quickness", "Alacrity", "Regeneration", "Vigor"],
            "revenant-conduit": ["Might", "Alacrity", "Regeneration", "Protection", "Vigor"],
            "warrior": ["Might", "Vigor", "Swiftness"],
            "warrior-berserker": ["Might", "Vigor", "Swiftness", "Fury"],
            "warrior-spellbreaker": ["Might", "Vigor", "Stability", "Protection"],
            "warrior-bladesworn": ["Might", "Fury", "Swiftness", "Vigor", "Quickness"],
            "warrior-paragon": ["Might", "Vigor", "Swiftness", "Stability", "Protection"],
            "ranger": ["Might", "Vigor", "Swiftness", "Regeneration"],
            "ranger-druid": ["Regeneration", "Vigor", "Swiftness", "Might"],
            "ranger-soulbeast": ["Might", "Vigor", "Fury", "Quickness"],
            "ranger-untamed": ["Might", "Vigor", "Swiftness", "Fury", "Resolution"],
            "ranger-galeshot": ["Might", "Vigor", "Swiftness", "Alacrity"],
            "engineer": ["Might", "Swiftness", "Regeneration", "Resistance"],
            "engineer-scrapper": ["Might", "Vigor", "Swiftness", "Regeneration", "Protection"],
            "engineer-holosmith": ["Might", "Fury", "Protection", "Swiftness"],
            "engineer-mechanist": ["Might", "Vigor", "Swiftness", "Regeneration", "Protection", "Stability"],
            "engineer-amalgam": ["Might", "Vigor", "Swiftness", "Protection", "Regeneration"],
            "thief": ["Vigor", "Swiftness", "Fury"],
            "thief-daredevil": ["Vigor", "Swiftness", "Fury", "Might"],
            "thief-deadeye": ["Vigor", "Fury", "Swiftness"],
            "thief-specter": ["Vigor", "Regeneration", "Swiftness", "Resolution"],
            "thief-antiquary": ["Vigor", "Swiftness", "Regeneration"],
            "elementalist": ["Fury", "Might", "Regeneration", "Protection"],
            "elementalist-tempest": ["Fury", "Might", "Vigor", "Swiftness", "Protection", "Stability"],
            "elementalist-weaver": ["Fury", "Might", "Vigor", "Swiftness", "Protection"],
            "elementalist-catalyst": ["Might", "Vigor", "Regeneration", "Stability", "Protection", "Swiftness"],
            "elementalist-evoker": ["Might", "Fury", "Vigor", "Swiftness", "Regeneration"],
            "mesmer": ["Alacrity", "Quickness", "Swiftness", "Regeneration"],
            "mesmer-chronomancer": ["Alacrity", "Quickness", "Regeneration", "Swiftness", "Vigor"],
            "mesmer-mirage": ["Alacrity", "Vigor", "Regeneration", "Protection", "Swiftness"],
            "mesmer-virtuoso": ["Alacrity", "Quickness", "Vigor", "Swiftness"],
            "mesmer-troubadour": ["Alacrity", "Quickness", "Regeneration", "Vigor", "Stability"],
            "necromancer": ["Might", "Regeneration", "Stability"],
            "necromancer-reaper": ["Might", "Regeneration", "Stability", "Vigor"],
            "necromancer-scourge": ["Might", "Regeneration", "Stability", "Protection", "Resolution"],
            "necromancer-harbinger": ["Might", "Regeneration", "Vigor", "Stability", "Alacrity"],
            "necromancer-ritualist": ["Might", "Regeneration", "Stability", "Alacrity", "Resistance"]
        };

        // Recommended Builds Database (Sourced from Metabattle WvW Zerg/Roaming)
        const recommendedBuilds = {
            // GUARDIAN
            "guardian-firebrand": [
                { name: "[Zerg] Support Firebrand (Meta)", url: "https://metabattle.com/wiki/Build:Firebrand_-_Support_Firebrand" },
                { name: "[Zerg] Valor Firebrand (Meta)", url: "https://metabattle.com/wiki/Build:Firebrand_-_Valor_Firebrand" }
            ],
            "guardian-dragonhunter": [
                { name: "[Roaming] Radiant Trapper", url: "https://metabattle.com/wiki/Build:Dragonhunter_-_Radiant_Trapper_Roamer" }
            ],
            "guardian-willbender": [
                { name: "[Roaming] Radiant Spearbender", url: "https://metabattle.com/wiki/Build:Willbender_-_Radiant_Spearbender_Roamer" },
                { name: "[Roaming] Radiant Swordbender", url: "https://metabattle.com/wiki/Build:Willbender_-_Radiant_Swordbender_Roamer" }
            ],
            "guardian": [
                { name: "[Roaming] Radiant Greatsword", url: "https://metabattle.com/wiki/Build:Guardian_-_Radiant_Greatsword_Roamer" }
            ],

            // WARRIOR
            "warrior-spellbreaker": [
                { name: "[Roaming] Spearbreaker", url: "https://metabattle.com/wiki/Build:Spellbreaker_-_Spearbreaker_Roamer" },
                { name: "[Roaming] Staffbreaker", url: "https://metabattle.com/wiki/Build:Spellbreaker_-_Staffbreaker_Roamer" }
            ],
            "warrior-berserker": [
                { name: "[Roaming] Defensive Condizerker", url: "https://metabattle.com/wiki/Build:Berserker_-_Defensive_Condizerker_Roamer" }
            ],
            "warrior-bladesworn": [
                { name: "[Roaming] Defense Bladesworn", url: "https://metabattle.com/wiki/Build:Bladesworn_-_Defense_Bladesworn_Roamer" }
            ],

            // REVENANT
            "revenant-herald": [
                { name: "[Roaming] Celestial Herald", url: "https://metabattle.com/wiki/Build:Herald_-_Celestial_Herald_Roamer" },
                { name: "[Roaming] Shiro Roamer", url: "https://metabattle.com/wiki/Build:Herald_-_Shiro_Roamer" }
            ],
            "revenant-vindicator": [
                { name: "[Roaming] Defensive Power Vindi", url: "https://metabattle.com/wiki/Build:Vindicator_-_Defensive_Power_Vindi_Roamer" },
                { name: "[Roaming] Retribution Greatsword", url: "https://metabattle.com/wiki/Build:Vindicator_-_Retribution_Greatsword_Roamer" }
            ],
            "revenant-renegade": [
                { name: "[Roaming] Celestial Renegade", url: "https://metabattle.com/wiki/Build:Renegade_-_Celestial_Renegade_Roamer" }
            ],

            // RANGER
            "ranger-druid": [
                { name: "[Zerg] Support Druid (Meta)", url: "https://metabattle.com/wiki/Build:Druid_-_Support_Druid" },
                { name: "[Roaming] Celestial Eclipse", url: "https://metabattle.com/wiki/Build:Druid_-_Celestial_Eclipse_Roamer" }
            ],
            "ranger-soulbeast": [
                { name: "[Roaming] Poisonbeast", url: "https://metabattle.com/wiki/Build:Soulbeast_-_Poisonbeast_Roamer" }
            ],
            "ranger-untamed": [
                { name: "[Roaming] Power Longbow", url: "https://metabattle.com/wiki/Build:Untamed_-_Power_Longbow_Roamer" }
            ],

            // ENGINEER
            "engineer-scrapper": [
                { name: "[Zerg] Power Explosives (Meta)", url: "https://metabattle.com/wiki/Build:Scrapper_-_Power_Explosives" },
                { name: "[Roaming] Explosive Hammer", url: "https://metabattle.com/wiki/Build:Scrapper_-_Explosive_Hammer_Roamer" },
                { name: "[Roaming] Superspeed Grenadier", url: "https://metabattle.com/wiki/Build:Scrapper_-_Superspeed_Grenadier_Roamer" }
            ],
            "engineer-holosmith": [
                { name: "[Roaming] Celestial Elixir Holo", url: "https://metabattle.com/wiki/Build:Holosmith_-_Celestial_Elixir_Holo_Roamer" },
                { name: "[Roaming] Tools Holo", url: "https://metabattle.com/wiki/Build:Holosmith_-_Tools_Holo_Roamer" }
            ],
            "engineer-mechanist": [
                { name: "[Roaming] Condition Mecha", url: "https://metabattle.com/wiki/Build:Mechanist_-_Condition_Mecha_Roamer" },
                { name: "[Roaming] Rifle Mecha", url: "https://metabattle.com/wiki/Build:Mechanist_-_Rifle_Mecha_Roamer" }
            ],

            // THIEF
            "thief-daredevil": [
                { name: "[Roaming] Celestial SA A/P", url: "https://metabattle.com/wiki/Build:Daredevil_-_Celestial_SA_A/P_Roamer" },
                { name: "[Roaming] Power S/D", url: "https://metabattle.com/wiki/Build:Daredevil_-_Power_S/D_Roamer" }
            ],
            "thief-deadeye": [
                { name: "[Roaming] SA Rifle", url: "https://metabattle.com/wiki/Build:Deadeye_-_SA_Rifle_Roamer" }
            ],
            "thief-specter": [
                { name: "[Roaming] Celestial Scepter", url: "https://metabattle.com/wiki/Build:Specter_-_Celestial_Scepter_Roamer" }
            ],

            // ELEMENTALIST
            "elementalist-catalyst": [
                { name: "[Roaming] Celestial D/D", url: "https://metabattle.com/wiki/Build:Catalyst_-_Celestial_D/D_Roamer" },
                { name: "[Roaming] Fresh Air Cata", url: "https://metabattle.com/wiki/Build:Catalyst_-_Fresh_Air_Cata_Roamer" }
            ],
            "elementalist-weaver": [
                { name: "[Roaming] Starfire Roamer", url: "https://metabattle.com/wiki/Build:Weaver_-_Starfire_Roamer" }
            ],
            "elementalist-tempest": [
                { name: "[Roaming] Condition Auroamancer", url: "https://metabattle.com/wiki/Build:Tempest_-_Condition_Auroamancer" }
            ],

            // MESMER
            "mesmer-mirage": [
                { name: "[Roaming] Celestial Daze Spammer", url: "https://metabattle.com/wiki/Build:Mirage_-_Celestial_Daze_Spammer_Roamer" },
                { name: "[Roaming] Shatter Mirage", url: "https://metabattle.com/wiki/Build:Mirage_-_Shatter_Mirage" }
            ],
            "mesmer-virtuoso": [
                { name: "[Roaming] Power Speartuoso", url: "https://metabattle.com/wiki/Build:Virtuoso_-_Power_Speartuoso_Roamer" }
            ],
            "mesmer-chronomancer": [
                { name: "[Roaming] Power Shatter Chrono", url: "https://metabattle.com/wiki/Build:Chronomancer_-_Power_Shatter_Chrono_Roamer" }
            ],

            // NECROMANCER
            "necromancer-scourge": [
                { name: "[Zerg] Power Scourge (Meta)", url: "https://metabattle.com/wiki/Build:Scourge_-_Power_Scourge" }
            ],
            "necromancer-reaper": [
                { name: "[Roaming] Celestial Reaper", url: "https://metabattle.com/wiki/Build:Reaper_-_Celestial_Reaper_Roamer" },
                { name: "[Roaming] Power Curses", url: "https://metabattle.com/wiki/Build:Reaper_-_Power_Curses_Roamer" }
            ],
            "necromancer-harbinger": [
                { name: "[Roaming] Celestial Elixir", url: "https://metabattle.com/wiki/Build:Harbinger_-_Celestial_Elixir_Roamer" },
                { name: "[Roaming] Spear Vampbringer", url: "https://metabattle.com/wiki/Build:Harbinger_-_Spear_Vampbringer_Roamer" }
            ],
            "necromancer": [
                { name: "[Roaming] Core Condi", url: "https://metabattle.com/wiki/Build:Necromancer_-_Core_Condi_Roamer" }
            ]
        };

        // Boon icons from GW2 Wiki (using static paths)
        const boonIcons = {
            "Might": "https://wiki.guildwars2.com/images/7/7c/Might.png",
            "Fury": "https://wiki.guildwars2.com/images/4/46/Fury.png",
            "Quickness": "https://wiki.guildwars2.com/images/b/b4/Quickness.png",
            "Alacrity": "https://wiki.guildwars2.com/images/4/4c/Alacrity.png",
            "Protection": "https://wiki.guildwars2.com/images/6/6c/Protection.png",
            "Aegis": "https://wiki.guildwars2.com/images/e/e5/Aegis.png",
            "Stability": "https://wiki.guildwars2.com/images/a/ae/Stability.png",
            "Vigor": "https://wiki.guildwars2.com/images/f/f4/Vigor.png",
            "Regeneration": "https://wiki.guildwars2.com/images/5/53/Regeneration.png",
            "Resolution": "https://wiki.guildwars2.com/images/0/06/Resolution.png",
            "Resistance": "https://wiki.guildwars2.com/images/4/4b/Resistance.png",
            "Swiftness": "https://wiki.guildwars2.com/images/a/af/Swiftness.png"
        };


        // Data management
        const rosterData = JSON.parse(localStorage.getItem('gw2Roster')) || [];
        const squadsData = JSON.parse(localStorage.getItem('gw2Squads')) || [];
        const defaultRoleTargets = allowedRoles.reduce((acc, r) => { acc[r] = 0; return acc; }, {});
        const roleTargets = { ...defaultRoleTargets, ...(JSON.parse(localStorage.getItem('gw2RoleTargets')) || {}) };

        // --- MIGRATION LOGIC (Old Roles -> New Roles) ---
        (function migrateRoles() {
            const roleMigrationMap = {
                "ranged-healer": "support-cleanse",
                "melee-healer": "support-stab",
                "cleanse-support": "support-cleanse",
                "boon-support": "support-stab",
                "frontline-dps": "dps-melee",
                "ranged-dps": "dps-ranged",
                "backline-dps": "dps-ranged",
                "utility": "dps-strip",
                "flexible": "roamer"
            };

            let dataChanged = false;

            // 1. Migrate Roster Data
            rosterData.forEach(char => {
                if (roleMigrationMap[char.role]) {
                    char.role = roleMigrationMap[char.role];
                    dataChanged = true;
                }
            });

            if (dataChanged) {
                localStorage.setItem('gw2Roster', JSON.stringify(rosterData));
                console.log("Migrated roster data to new role schema.");
            }

            // 2. Migrate Role Targets
            let targetsChanged = false;
            // Check for old keys in roleTargets and move their values to new keys
            Object.keys(roleTargets).forEach(key => {
                if (roleMigrationMap[key]) {
                    const newKey = roleMigrationMap[key];
                    // Add the count from the old role to the new role
                    roleTargets[newKey] = (roleTargets[newKey] || 0) + roleTargets[key];
                    // Remove the old key
                    delete roleTargets[key];
                    targetsChanged = true;
                }
            });

            // Also ensure no other invalid keys remain (optional, but good for cleanup)
            Object.keys(roleTargets).forEach(key => {
                if (!allowedRoles.includes(key)) {
                    delete roleTargets[key];
                    targetsChanged = true;
                }
            });

            if (targetsChanged) {
                localStorage.setItem('gw2RoleTargets', JSON.stringify(roleTargets));
                console.log("Migrated role targets to new schema.");
            }
        })();
        // ------------------------------------------------

        // Validation helpers
        function validateCharacterRecord(rec) {
            const errors = [];
            if (!rec.playerName) errors.push('playerName is required');
            if (!rec.characterName) errors.push('characterName is required');
            if (!rec.role || !allowedRoles.includes(rec.role)) errors.push('role must be one of the predefined options');
            if (!rec.classSpec || !boonsByClass[rec.classSpec]) errors.push('classSpec is required and must be valid');
            if (!rec.gear || !allowedGear.includes(rec.gear)) errors.push('gear must be one of the predefined options');
            if (rec.tags && !Array.isArray(rec.tags)) errors.push('tags must be an array');
            return { valid: errors.length === 0, errors };
        }

        function isDuplicateCharacter(rec, list) {
            return list.some(c =>
                c.playerName.toLowerCase() === rec.playerName.toLowerCase() &&
                c.characterName.toLowerCase() === rec.characterName.toLowerCase()
            );
        }

        // Save squads to localStorage
        function saveSquads() {
            localStorage.setItem('gw2Squads', JSON.stringify(squadsData));
        }

        function saveRoleTargets() {
            localStorage.setItem('gw2RoleTargets', JSON.stringify(roleTargets));
        }

        // Populate boon class select
        function populateBoonSelect() {
            const select = document.getElementById('boonClassSelect');
            const optgroups = {};
            
            for (const [classSpec, boons] of Object.entries(boonsByClass)) {
                const parts = classSpec.split('-');
                const className = parts[0].charAt(0).toUpperCase() + parts[0].slice(1);
                
                if (!optgroups[className]) {
                    optgroups[className] = [];
                }
                optgroups[className].push({ value: classSpec, label: classSpec === parts[0] ? `${className} (Base)` : `${className} - ${parts[1].charAt(0).toUpperCase() + parts[1].slice(1)}` });
            }
            
            select.innerHTML = '<option value="">-- Select Class/Spec to see Boons --</option>';
            for (const [className, specs] of Object.entries(optgroups)) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = className;
                specs.forEach(spec => {
                    const option = document.createElement('option');
                    option.value = spec.value;
                    option.textContent = spec.label;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            }
        }

        // Populate boon filter select
        function populateBoonFilterSelect() {
            const select = document.getElementById('boonFilterSelect');
            const boons = Object.keys(boonIcons).sort();
            
            select.innerHTML = '<option value="">-- Select Boon to find Classes --</option>' + 
                boons.map(boon => `<option value="${boon}">${boon}</option>`).join('');
        }

        // Display classes for selected boon
        document.getElementById('boonFilterSelect').addEventListener('change', function(e) {
            const selectedBoon = this.value;
            const displayArea = document.getElementById('classesByBoonDisplay');
            
            if (!selectedBoon) {
                displayArea.innerHTML = '';
                return;
            }
            
            const matchingClasses = [];
            for (const [classSpec, boons] of Object.entries(boonsByClass)) {
                if (boons.includes(selectedBoon)) {
                    matchingClasses.push(classSpec);
                }
            }
            
            if (matchingClasses.length === 0) {
                displayArea.innerHTML = '<div class="text-gray-500 italic">No classes found providing this boon.</div>';
                return;
            }

            // Group by base class for better display
            const grouped = {};
            matchingClasses.forEach(spec => {
                const parts = spec.split('-');
                const className = parts[0].charAt(0).toUpperCase() + parts[0].slice(1);
                const specName = parts[1] ? (parts[1].charAt(0).toUpperCase() + parts[1].slice(1)) : 'Base';
                
                if (!grouped[className]) grouped[className] = [];
                grouped[className].push(specName);
            });

            let html = '';
            for (const [className, specs] of Object.entries(grouped)) {
                html += `
                    <div class="bg-gray-800 p-3 rounded border border-gray-700">
                        <div class="font-bold text-blue-400 mb-1">${className}</div>
                        <div class="flex flex-wrap gap-2">
                            ${specs.map(s => `<span class="tag-pill bg-gray-700 text-gray-300 border-gray-600">${s}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            displayArea.innerHTML = html;
        });

        // Display boons for selected class
        document.getElementById('boonClassSelect').addEventListener('change', function(e) {
            const classSpec = this.value;
            const displayArea = document.getElementById('boonDisplayArea');
            const addBtn = document.getElementById('addGenericBtn');
            
            if (!classSpec || !boonsByClass[classSpec]) {
                displayArea.innerHTML = '';
                addBtn.style.display = 'none';
                return;
            }
            
            addBtn.style.display = 'block';
            const boons = boonsByClass[classSpec];
            let html = boons.map(boon => `
                <div style="background: #4A5568; border-radius: 8px; padding: 10px; text-align: center; color: white; font-weight: bold; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; min-height: 70px;">
                    <img src="${boonIcons[boon] || ''}" alt="${boon}" style="width: 32px; height: 32px; filter: drop-shadow(0 0 2px rgba(0,0,0,0.8));">
                    <span style="font-size: 12px;">${boon}</span>
                </div>
            `).join('');

            // Append Recommended Builds
            if (recommendedBuilds[classSpec] && recommendedBuilds[classSpec].length > 0) {
                html += `
                    <div class="col-span-full mt-4 pt-4 border-t border-gray-600">
                        <h4 class="text-sm font-bold text-gray-300 mb-2">Recommended Builds</h4>
                        <div class="flex flex-wrap gap-2">
                            ${recommendedBuilds[classSpec].map(build => `
                                <a href="${build.url}" target="_blank" class="btn-secondary text-xs flex items-center gap-1 hover:text-blue-300">
                                    üîó ${build.name}
                                </a>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            displayArea.innerHTML = html;
        });

        // Add Generic Character
        document.getElementById('addGenericBtn').addEventListener('click', function() {
            const classSpec = document.getElementById('boonClassSelect').value;
            if (!classSpec) return;

            const parts = classSpec.split('-');
            const className = parts[0].charAt(0).toUpperCase() + parts[0].slice(1);
            const specName = parts[1] ? (parts[1].charAt(0).toUpperCase() + parts[1].slice(1)) : 'Core';
            const displayName = parts[1] ? `${specName}` : `${className}`;

            const character = {
                id: Date.now(),
                playerName: 'Generic',
                characterName: `${displayName} (Generic)`,
                role: 'flexible',
                subgroup: 1,
                classSpec: classSpec,
                gear: 'exotic',
                notes: 'Auto-generated generic character',
                tags: ['generic'],
                addedDate: new Date().toLocaleDateString()
            };

            rosterData.push(character);
            saveRoster();
            renderRoster();
            updateTeamBoons();
            updateSubgroupAnalysis();
            alert(`Added generic ${displayName} to roster.`);
        });

        // Form submission
        document.getElementById('characterForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const character = {
                id: Date.now(),
                playerName: document.getElementById('playerName').value.trim(),
                characterName: document.getElementById('characterName').value.trim(),
                role: document.getElementById('role').value,
                subgroup: parseInt(document.getElementById('subgroup').value) || 1,
                classSpec: document.getElementById('classSpec').value,
                gear: document.getElementById('gear').value,
                notes: document.getElementById('notes').value.trim(),
                tags: (document.getElementById('tags').value || '').split(',').map(t => t.trim()).filter(Boolean),
                buildLink: document.getElementById('buildLink').value.trim(),
                addedDate: new Date().toLocaleDateString()
            };

            const validation = validateCharacterRecord(character);
            if (!validation.valid) {
                alert('Cannot add character:\n- ' + validation.errors.join('\n- '));
                return;
            }

            if (isDuplicateCharacter(character, rosterData)) {
                const proceed = confirm('A character with the same player and name already exists. Add anyway?');
                if (!proceed) return;
            }

            rosterData.push(character);
            saveRoster();
            renderRoster();
            updateTeamBoons();
            updateSubgroupAnalysis();
            this.reset();
            document.getElementById('subgroup').value = "1"; // Reset to default
            
            // Show success message
            alert(`${character.characterName} has been added to the roster!`);
        });

        // Save to localStorage
        function saveRoster() {
            localStorage.setItem('gw2Roster', JSON.stringify(rosterData));
        }

        let editingId = null;
        let sortState = { field: 'subgroup', direction: 'asc' };
        let filterState = { search: '', role: '', gear: '', tag: '' };

        function applyFilters(list) {
            return list.filter(item => {
                const matchesSearch = filterState.search === '' || (
                    item.playerName.toLowerCase().includes(filterState.search) ||
                    item.characterName.toLowerCase().includes(filterState.search) ||
                    (item.notes || '').toLowerCase().includes(filterState.search)
                );
                const matchesRole = filterState.role === '' || item.role === filterState.role;
                const matchesGear = filterState.gear === '' || item.gear === filterState.gear;
                const matchesTag = filterState.tag === '' || (item.tags || []).some(t => t.toLowerCase() === filterState.tag);
                return matchesSearch && matchesRole && matchesGear && matchesTag;
            });
        }

        function applySort(list) {
            const sorted = [...list];
            sorted.sort((a, b) => {
                const field = sortState.field;
                const dir = sortState.direction === 'asc' ? 1 : -1;
                
                // Numeric sort for subgroup
                if (field === 'subgroup') {
                    return ((a.subgroup || 1) - (b.subgroup || 1)) * dir;
                }

                const va = (a[field] || '').toString().toLowerCase();
                const vb = (b[field] || '').toString().toLowerCase();
                if (va < vb) return -1 * dir;
                if (va > vb) return 1 * dir;
                return 0;
            });
            return sorted;
        }

        function renderRoleTargetsUI() {
            const container = document.getElementById('roleTargetsContainer');
            if (!container) return;
            container.innerHTML = allowedRoles.map(role => {
                const targetVal = roleTargets[role] ?? 0;
                return `
                    <div class="grid grid-cols-12 items-center gap-2 bg-[rgba(0,0,0,0.25)] px-3 py-2 rounded mb-1">
                        <div class="col-span-5 text-gray-100 font-medium truncate" title="${roleLabels[role] || role}">${roleLabels[role] || role}</div>
                        <input data-role-target="${role}" type="number" min="0" class="input-field col-span-2 text-center font-bold" value="${targetVal}" aria-label="Target for ${roleLabels[role] || role}">
                        <div class="text-sm text-gray-300 col-span-3 text-center font-mono" id="role-target-status-${role}"></div>
                        <button onclick="openQuickAddModal('${role}')" class="col-span-2 btn-secondary text-xs px-2 py-1 h-full flex items-center justify-center" title="Quick Add Character">+ Add</button>
                    </div>
                `;
            }).join('');
            updateRoleTargetsStatus();
            const presetSelect = document.getElementById('rolePresetSelect');
            if (presetSelect) {
                presetSelect.innerHTML = '<option value="">Select preset</option>' + Object.entries(rolePresets).map(([key, preset]) => `
                    <option value="${key}" title="${preset.description || ''}">${preset.label}</option>
                `).join('');
            }
        }

        // --- Quick Add Logic ---
        let currentQuickAddRole = null;

        function openQuickAddModal(role) {
            currentQuickAddRole = role;
            document.getElementById('quickAddTitle').textContent = `Quick Add: ${roleLabels[role] || role}`;
            
            // Populate Specs
            const select = document.getElementById('quickAddSpec');
            select.innerHTML = '<option value="">Select Profession/Spec</option>';
            
            // Sort specs alphabetically
            const specs = Object.keys(boonsByClass).sort();
            
            specs.forEach(spec => {
                const parts = spec.split('-');
                const className = capitalize(parts[0]);
                const specName = parts[1] ? capitalize(parts[1]) : 'Core';
                select.innerHTML += `<option value="${spec}">${className} - ${specName}</option>`;
            });

            document.getElementById('quickAddModal').classList.remove('hidden');
        }

        function closeQuickAddModal() {
            document.getElementById('quickAddModal').classList.add('hidden');
            currentQuickAddRole = null;
        }

        function confirmQuickAdd() {
            if (!currentQuickAddRole) return;
            
            const spec = document.getElementById('quickAddSpec').value;
            const subgroup = parseInt(document.getElementById('quickAddSubgroup').value);
            
            if (!spec) {
                alert('Please select a profession/spec.');
                return;
            }

            const parts = spec.split('-');
            const className = capitalize(parts[0]);
            const specName = parts[1] ? capitalize(parts[1]) : 'Core';

            const newChar = {
                id: Date.now(),
                playerName: `(Fill) ${specName}`,
                characterName: `${specName} ${currentQuickAddRole.split('-')[1] || 'Fill'}`,
                role: currentQuickAddRole,
                classSpec: spec,
                gear: 'exotic', // Default for fills
                subgroup: subgroup,
                notes: 'Auto-filled',
                tags: ['Fill'],
                buildLink: ''
            };

            rosterData.push(newChar);
            saveRoster();
            renderRoster();
            updateTeamBoons();
            updateSubgroupAnalysis();
            updateRoleTargetsStatus();
            
            closeQuickAddModal();
            // alert('Character added!'); // Optional feedback
        }
        // -----------------------

        function updateRoleTargetsStatus() {
            const counts = rosterData.reduce((acc, c) => {
                acc[c.role] = (acc[c.role] || 0) + 1;
                return acc;
            }, {});
            allowedRoles.forEach(role => {
                const target = Number(roleTargets[role] || 0);
                const current = counts[role] || 0;
                const delta = current - target;
                const el = document.getElementById(`role-target-status-${role}`);
                if (el) {
                    const status = target === 0 ? 'No target set' : `${current}/${target} (${delta >= 0 ? '+' : ''}${delta})`;
                    const color = delta >= 0 ? '#00FF88' : '#FF6B6B';
                    el.textContent = status;
                    el.style.color = color;
                }
            });
        }

        function renderRoster() {
            const tbody = document.getElementById('rosterBody');
            
            if (rosterData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">No characters registered yet. Add your first character above!</td></tr>';
                updateStats();
                updateSubgroupAnalysis();
                return;
            }

            const filtered = applyFilters(rosterData);
            const sorted = applySort(filtered);

            if (sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">No entries match the current filters.</td></tr>';
                updateStats();
                updateSubgroupAnalysis();
                return;
            }

            tbody.innerHTML = sorted.map(char => {
                const isEditing = editingId === char.id;
                const tagHtml = (char.tags || []).map(t => `<span class="tag-pill">${escapeHtml(t)}</span>`).join('');
                if (isEditing) {
                    return `
                        <tr>
                            <td>
                                <select id="editSubgroup" class="input-field w-full" style="min-width: 60px;">
                                    ${Array.from({length: 15}, (_, i) => i + 1).map(n => 
                                        `<option value="${n}" ${char.subgroup === n ? 'selected' : ''}>${n}</option>`
                                    ).join('')}
                                </select>
                            </td>
                            <td><input class="input-field w-full" id="editPlayerName" value="${escapeHtml(char.playerName)}"></td>
                            <td><input class="input-field w-full" id="editCharacterName" value="${escapeHtml(char.characterName)}"></td>
                            <td>
                                <select id="editRole" class="input-field w-full">
                                    <option value="support-stab">Support (Stab/Aegis)</option>
                                    <option value="support-cleanse">Support (Cleanse/Heal)</option>
                                    <option value="dps-melee">DPS (Melee/Front)</option>
                                    <option value="dps-ranged">DPS (Ranged/Back)</option>
                                    <option value="dps-strip">DPS (Strip/Control)</option>
                                    <option value="roamer">Roamer / Havoc</option>
                                </select>
                            </td>
                            <td><input class="input-field w-full" id="editClassSpec" value="${escapeHtml(char.classSpec)}"></td>
                            <td>
                                <select id="editGear" class="input-field w-full">
                                    <option value="legendary">Legendary</option>
                                    <option value="ascended">Ascended</option>
                                    <option value="exotic">Exotic</option>
                                    <option value="rare">Rare</option>
                                    <option value="mixed">Mixed / Leveling</option>
                                </select>
                            </td>
                            <td>
                                <textarea class="input-field w-full" id="editNotes" rows="2">${escapeHtml(char.notes || '')}</textarea>
                                <input class="input-field w-full mt-2" id="editTags" value="${escapeHtml((char.tags || []).join(', '))}" placeholder="tags comma separated">
                                <input class="input-field w-full mt-2" id="editBuildLink" value="${escapeHtml(char.buildLink || '')}" placeholder="Build URL">
                            </td>
                            <td class="space-x-2">
                                <button onclick="saveEdit(${char.id})" class="btn-primary text-sm" aria-label="Save edits">Save</button>
                                <button onclick="cancelEdit()" class="btn-secondary text-sm" aria-label="Cancel edits">Cancel</button>
                            </td>
                        </tr>
                    `;
                }

                return `
                    <tr>
                        <td class="text-center font-bold text-gray-400">${char.subgroup || 1}</td>
                        <td><strong>${escapeHtml(char.playerName)}</strong></td>
                        <td>${escapeHtml(char.characterName)}</td>
                        <td><span class="badge">${capitalize(char.role)}</span></td>
                        <td>${escapeHtml(char.classSpec)}</td>
                        <td><span class="badge">${char.gear}</span></td>
                        <td>
                            ${escapeHtml(char.notes || '-')}
                            <div>${tagHtml || ''}</div>
                            ${char.buildLink ? `<div class="mt-1"><a href="${escapeHtml(char.buildLink)}" target="_blank" class="text-blue-400 hover:text-blue-300 text-xs flex items-center gap-1">üîó Build Link</a></div>` : ''}
                        </td>
                        <td class="space-x-2">
                            <button onclick="startEdit(${char.id})" class="btn-secondary text-sm" aria-label="Edit character">Edit</button>
                            <button onclick="deleteCharacter(${char.id})" class="text-red-400 hover:text-red-300 text-sm font-semibold" aria-label="Delete character">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');

            updateStats();
            updateSubgroupAnalysis();
        }

        function startEdit(id) {
            editingId = id;
            renderRoster();
            const char = rosterData.find(c => c.id === id);
            if (char) {
                document.getElementById('editRole').value = char.role;
                document.getElementById('editGear').value = char.gear;
                document.getElementById('editSubgroup').value = char.subgroup || 1;
            }
        }

        function cancelEdit() {
            editingId = null;
            renderRoster();
        }

        function saveEdit(id) {
            const char = rosterData.find(c => c.id === id);
            if (!char) return;
            const updated = {
                ...char,
                playerName: document.getElementById('editPlayerName').value.trim(),
                characterName: document.getElementById('editCharacterName').value.trim(),
                role: document.getElementById('editRole').value,
                subgroup: parseInt(document.getElementById('editSubgroup').value) || 1,
                classSpec: document.getElementById('editClassSpec').value.trim(),
                gear: document.getElementById('editGear').value,
                notes: document.getElementById('editNotes').value.trim(),
                tags: (document.getElementById('editTags').value || '').split(',').map(t => t.trim()).filter(Boolean),
                buildLink: document.getElementById('editBuildLink').value.trim()
            };

            const validation = validateCharacterRecord(updated);
            if (!validation.valid) {
                alert('Cannot save changes:\n- ' + validation.errors.join('\n- '));
                return;
            }

            // Check duplicates excluding self
            const duplicate = rosterData.some(c => c.id !== id && c.playerName.toLowerCase() === updated.playerName.toLowerCase() && c.characterName.toLowerCase() === updated.characterName.toLowerCase());
            if (duplicate) {
                const proceed = confirm('Another entry with the same player and character exists. Save anyway?');
                if (!proceed) return;
            }

            Object.assign(char, updated);
            saveRoster();
            editingId = null;
            renderRoster();
            updateTeamBoons();
            updateSubgroupAnalysis();
        }

        // Delete character
        function deleteCharacter(id) {
            if (confirm('Are you sure you want to delete this character?')) {
                const index = rosterData.findIndex(c => c.id === id);
                if (index > -1) {
                    rosterData.splice(index, 1);
                    saveRoster();
                    renderRoster();
                    updateTeamBoons();
                    updateSubgroupAnalysis();
                }
            }
        }

        // Update statistics
        function updateStats() {
            const uniquePlayers = new Set(rosterData.map(c => c.playerName)).size;
            document.getElementById('totalPlayers').textContent = uniquePlayers;
            document.getElementById('totalCharacters').textContent = rosterData.length;

            if (rosterData.length > 0) {
                const roles = rosterData.map(c => c.role);
                const commonRole = roles.reduce((a, b) => roles.filter(x => x === a).length > roles.filter(x => x === b).length ? a : b);
                document.getElementById('commonRole').textContent = capitalize(commonRole);

                const specs = rosterData.map(c => c.classSpec);
                const commonSpec = specs.reduce((a, b) => specs.filter(x => x === a).length > specs.filter(x => x === b).length ? a : b);
                document.getElementById('commonClass').textContent = commonSpec;
            }

            updateRoleTargetsStatus();
        }

        // Update Team Boons Analysis
        function updateTeamBoons() {
            const teamBoonDisplay = document.getElementById('teamBoonDisplay');
            const boonCoverageDisplay = document.getElementById('boonCoverageDisplay');
            const emptyMessage = document.getElementById('emptyRosterMessage');

            if (rosterData.length === 0) {
                teamBoonDisplay.innerHTML = '';
                boonCoverageDisplay.innerHTML = '';
                emptyMessage.style.display = 'block';
                return;
            }

            emptyMessage.style.display = 'none';

            // Collect all boons from roster characters
            const { counts: allBoons, providers: boonProvidedBy } = calculateBoons(rosterData);

            // Sort boons by frequency
            const sortedBoons = Object.entries(allBoons).sort((a, b) => b[1] - a[1]);

            // Display team boons
            if (sortedBoons.length === 0) {
                teamBoonDisplay.innerHTML = '<div class="col-span-full text-center text-gray-500">No boons in roster</div>';
            } else {
                teamBoonDisplay.innerHTML = sortedBoons.map(([boon, count]) => `
                    <div style="background: #4A5568; border-radius: 8px; padding: 10px; text-align: center; color: white; font-weight: bold; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); position: relative; cursor: help; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;" title="${boonProvidedBy[boon].join(', ')}">
                        <img src="${boonIcons[boon] || ''}" alt="${boon}" style="width: 28px; height: 28px; filter: drop-shadow(0 0 2px rgba(0,0,0,0.8));">
                        <div style="font-size: 10px; opacity: 0.9;">√ó${count}</div>
                    </div>
                `).join('');
            }

            // Display boon coverage summary
            const criticalBoons = ["Quickness", "Alacrity", "Might", "Protection"];
            const coverageHtml = criticalBoons.map(boon => {
                const provided = allBoons[boon] || 0;
                const providers = boonProvidedBy[boon] || [];
                const status = provided > 0 ? '‚úì' : '‚úó';
                const statusColor = provided > 0 ? '#00FF88' : '#FF6B6B';
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; border-left: 3px solid ${statusColor}; gap: 8px;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <img src="${boonIcons[boon] || ''}" alt="${boon}" style="width: 20px; height: 20px;">
                            <div>
                                <strong>${boon}</strong>
                                <div style="font-size: 12px; color: #999;">Provided by ${provided > 0 ? providers.length : 0} member(s)</div>
                            </div>
                        </div>
                        <span style="font-size: 18px; color: ${statusColor}; font-weight: bold;">${status}</span>
                    </div>
                `;
            }).join('');

            boonCoverageDisplay.innerHTML = coverageHtml;
        }

        // Subgroup Analysis
        function updateSubgroupAnalysis() {
            const container = document.getElementById('subgroupGrid');
            if (!container) return;

            // Group by subgroup
            const groups = {};
            for (let i = 1; i <= 15; i++) groups[i] = [];
            
            rosterData.forEach(c => {
                const sub = c.subgroup || 1;
                if (groups[sub]) groups[sub].push(c);
            });

            // Filter out empty groups unless they are between active groups (optional, but let's show active ones)
            // Actually, let's just show groups that have members, or maybe 1-5 by default?
            // Let's show only groups with members for now to save space
            const activeGroups = Object.entries(groups).filter(([k, v]) => v.length > 0);
            
            if (activeGroups.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500">No subgroups active.</div>';
                return;
            }

            container.innerHTML = activeGroups.map(([subNum, members]) => {
                const { counts: boons } = calculateBoons(members);
                const memberCount = members.length;
                const isFull = memberCount >= 5;
                const isOver = memberCount > 5;
                
                // Critical boons for subgroup
                const critical = ["Quickness", "Alacrity", "Might", "Protection", "Stability", "Aegis", "Regeneration", "Fury"];
                
                const boonStatus = critical.map(b => {
                    const hasBoon = boons[b] > 0;
                    const color = hasBoon ? '#00FF88' : '#444';
                    const opacity = hasBoon ? '1' : '0.3';
                    return `
                        <div title="${b}" style="opacity: ${opacity}; filter: grayscale(${hasBoon ? 0 : 1});">
                            <img src="${boonIcons[b]}" style="width: 20px; height: 20px;">
                        </div>
                    `;
                }).join('');

                return `
                    <div style="background: rgba(30, 30, 30, 0.9); border: 1px solid ${isOver ? '#ff4444' : '#444'}; border-radius: 8px; padding: 12px;">
                        <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                            <h4 class="font-bold text-lg text-gray-200">Subgroup ${subNum}</h4>
                            <span class="text-xs font-bold px-2 py-1 rounded ${isOver ? 'bg-red-900 text-red-200' : (isFull ? 'bg-green-900 text-green-200' : 'bg-gray-700 text-gray-300')}">
                                ${memberCount}/5
                            </span>
                        </div>
                        
                        <div class="flex gap-1 mb-4 justify-center bg-black/20 p-2 rounded">
                            ${boonStatus}
                        </div>

                        <div class="space-y-1 text-sm">
                            ${members.map(m => `
                                <div class="flex justify-between items-center text-gray-400">
                                    <span class="truncate w-24" title="${m.characterName}">${m.characterName}</span>
                                    <span class="text-xs text-gray-500 truncate w-20 text-right">${m.classSpec.split('-')[1] || m.classSpec}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Export roster
        document.getElementById('exportBtn').addEventListener('click', function() {
            downloadJson(rosterData, `team-roster-${new Date().toISOString().split('T')[0]}.json`);
        });

        // Export filtered JSON
        document.getElementById('exportFilteredJsonBtn').addEventListener('click', function() {
            const filtered = applySort(applyFilters(rosterData));
            downloadJson(filtered, `team-roster-filtered-${new Date().toISOString().split('T')[0]}.json`);
        });

        // Export filtered CSV
        document.getElementById('exportCsvBtn').addEventListener('click', function() {
            const filtered = applySort(applyFilters(rosterData));
            if (filtered.length === 0) {
                alert('No data to export for current filters.');
                return;
            }
            const header = ['playerName','characterName','role','classSpec','gear','notes','tags'];
            const rows = filtered.map(c => [
                c.playerName,
                c.characterName,
                c.role,
                c.classSpec,
                c.gear,
                (c.notes || '').replace(/"/g,'""'),
                (c.tags || []).join('|')
            ]);
            const csv = [header.join(',')].concat(rows.map(r => r.map(v => `"${(v||'').toString().replace(/"/g,'""')}"`).join(','))).join('\n');
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `team-roster-filtered-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        });

        // Import roster
        document.getElementById('importBtn').addEventListener('click', function() {
            document.getElementById('importFile').click();
        });

        // Clear Roster
        document.getElementById('clearRosterBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear the ENTIRE roster? This action cannot be undone.')) {
                rosterData.length = 0; // Clear array
                saveRoster();
                renderRoster();
                updateTeamBoons();
                updateSubgroupAnalysis();
                alert('Roster has been reset.');
            }
        });

        document.getElementById('importFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const imported = JSON.parse(event.target.result);
                    if (Array.isArray(imported)) {
                        const invalids = imported.map(validateCharacterRecord).filter(v => !v.valid);
                        if (invalids.length > 0) {
                            alert('Import cancelled due to invalid records. Please verify schema.');
                            return;
                        }
                        const duplicates = imported.filter(rec => isDuplicateCharacter(rec, rosterData));
                        let proceed = true;
                        if (duplicates.length > 0) {
                            proceed = confirm(`Detected ${duplicates.length} duplicate(s) (player+character). Import anyway and keep duplicates?`);
                        }
                        if (proceed && confirm(`Import ${imported.length} character(s)? This will add to existing roster.`)) {
                            rosterData.push(...imported);
                            saveRoster();
                            renderRoster();
                            alert('Roster imported successfully!');
                        }
                    } else {
                        alert('Invalid roster file format.');
                    }
                } catch (err) {
                    alert('Error reading file: ' + err.message);
                }
            };
            reader.readAsText(file);
        });

        // Import Squad from JSON
        document.getElementById('importSquadBtn').addEventListener('click', function() {
            document.getElementById('importSquadFile').click();
        });

        document.getElementById('importSquadFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const imported = JSON.parse(event.target.result);
                    if (Array.isArray(imported) && imported.length > 0) {
                        const invalids = imported.map(validateCharacterRecord).filter(v => !v.valid);
                        if (invalids.length > 0) {
                            alert('Import cancelled due to invalid records in squad.');
                            return;
                        }
                        const squadName = prompt('Enter a name for this squad:', `Squad ${squadsData.length + 1}`);
                        if (squadName) {
                            squadsData.push({
                                id: Date.now(),
                                name: squadName,
                                members: imported,
                                importedDate: new Date().toISOString()
                            });
                            saveSquads();
                            alert(`Squad "${squadName}" imported successfully with ${imported.length} members!`);
                        }
                    } else {
                        alert('Invalid squad file format.');
                    }
                } catch (err) {
                    alert('Error reading file: ' + err.message);
                }
            };
            reader.readAsText(file);
            this.value = ''; // Reset input
        });

        // Manage Squads Modal
        document.getElementById('manageSquadsBtn').addEventListener('click', function() {
            renderSquadsList();
            document.getElementById('squadsModal').style.display = 'block';
        });

        document.getElementById('closeSquadsModal').addEventListener('click', function() {
            document.getElementById('squadsModal').style.display = 'none';
            const panel = document.getElementById('squadAnalyticsPanel');
            if (panel) panel.style.display = 'none';
        });

        // Render Squads List
        function renderSquadsList() {
            const container = document.getElementById('squadsListContainer');
            
            if (squadsData.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">No squads imported yet. Import a JSON roster as a squad to get started.</div>';
                return;
            }

            container.innerHTML = squadsData.map(squad => {
                const { counts: allBoons } = calculateBoons(squad.members);
                const sortedBoons = Object.entries(allBoons).sort((a, b) => b[1] - a[1]).slice(0, 6);

                return `
                    <div style="background: rgba(35, 35, 35, 0.8); border-left: 4px solid #00d4ff; padding: 16px; margin-bottom: 16px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <h3 style="font-size: 18px; font-weight: bold; color: #00d4ff; margin-bottom: 4px;">${escapeHtml(squad.name)}</h3>
                                <p style="font-size: 12px; color: #999;">Imported: ${new Date(squad.importedDate).toLocaleDateString()} ‚Ä¢ ${squad.members.length} members</p>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="viewSquad(${squad.id})" class="btn-secondary" style="padding: 6px 12px; font-size: 12px;">View</button>
                                <button onclick="showSquadAnalytics(${squad.id})" class="btn-secondary" style="padding: 6px 12px; font-size: 12px;">Analytics</button>
                                <button onclick="exportSquad(${squad.id})" class="btn-secondary" style="padding: 6px 12px; font-size: 12px;">Export</button>
                                <button onclick="mergeSquadToRoster(${squad.id})" class="btn-primary" style="padding: 6px 12px; font-size: 12px;">Merge to Roster</button>
                                <button onclick="deleteSquad(${squad.id})" class="text-red-400 hover:text-red-300" style="padding: 6px 12px; font-size: 12px; font-weight: bold;">Delete</button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                            ${sortedBoons.map(([boon, count]) => `
                                <div style="display: flex; align-items: center; gap: 4px; background: rgba(0,0,0,0.5); padding: 4px 8px; border-radius: 4px;">
                                    <img src="${boonIcons[boon] || ''}" alt="${boon}" style="width: 16px; height: 16px;">
                                    <span style="font-size: 11px;">√ó${count}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showSquadAnalytics(squadId) {
            const panel = document.getElementById('squadAnalyticsPanel');
            const content = document.getElementById('squadAnalyticsContent');
            const squad = squadsData.find(s => s.id === squadId);
            if (!panel || !content || !squad) return;

            const roleCounts = {};
            const gearCounts = {};
            const tagCounts = {};

            squad.members.forEach(member => {
                roleCounts[member.role] = (roleCounts[member.role] || 0) + 1;
                gearCounts[member.gear] = (gearCounts[member.gear] || 0) + 1;
                (member.tags || []).forEach(t => {
                    const key = t.toLowerCase();
                    tagCounts[key] = (tagCounts[key] || 0) + 1;
                });
            });

            const { counts: boonCounts } = calculateBoons(squad.members);

            const roleHtml = Object.entries(roleCounts).map(([r,c]) => `<span class="tag-pill">${escapeHtml(roleLabels[r] || r)}: ${c}</span>`).join(' ');
            const gearHtml = Object.entries(gearCounts).map(([g,c]) => `<span class="tag-pill">${escapeHtml(g)}: ${c}</span>`).join(' ');
            const tagHtml = Object.entries(tagCounts).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([t,c]) => `<span class="tag-pill">${escapeHtml(t)}: ${c}</span>`).join(' ');
            const boonHtml = Object.entries(boonCounts).sort((a,b)=>b[1]-a[1]).map(([b,c]) => `
                <div style="display:flex;align-items:center;gap:8px;">
                    <img src="${boonIcons[b] || ''}" alt="${b}" style="width:20px;height:20px;">
                    <span>${b}</span>
                    <span class="text-gray-400 text-xs">√ó${c}</span>
                </div>
            `).join('');

            content.innerHTML = `
                <div><strong>Squad:</strong> ${escapeHtml(squad.name)} (${squad.members.length} members)</div>
                <div><strong>Roles:</strong> ${roleHtml || '‚Äî'}</div>
                <div><strong>Gear:</strong> ${gearHtml || '‚Äî'}</div>
                <div><strong>Top Tags:</strong> ${tagHtml || '‚Äî'}</div>
                <div><strong>Boons (full coverage):</strong><div class="grid grid-cols-2 sm:grid-cols-3 gap-2 mt-2">${boonHtml || '‚Äî'}</div></div>
            `;
            panel.style.display = 'block';
            panel.scrollIntoView({behavior:'smooth'});
        }

        // View Squad Details
        function viewSquad(squadId) {
            const squad = squadsData.find(s => s.id === squadId);
            if (!squad) return;

            const details = squad.members.map(m => 
                `‚Ä¢ ${m.characterName} (${m.playerName}) - ${m.classSpec} - ${m.role}`
            ).join('\n');

            alert(`Squad: ${squad.name}\n\nMembers (${squad.members.length}):\n${details}`);
        }

        // Export Squad as JSON
        function exportSquad(squadId) {
            const squad = squadsData.find(s => s.id === squadId);
            if (!squad) return;

            const fileName = squad.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            downloadJson(squad.members, `${fileName}_squad_${new Date().toISOString().split('T')[0]}.json`);
        }

        // Merge Squad to Roster
        function mergeSquadToRoster(squadId) {
            const squad = squadsData.find(s => s.id === squadId);
            if (!squad) return;

            const invalids = squad.members.map(validateCharacterRecord).filter(v => !v.valid);
            if (invalids.length > 0) {
                alert('Cannot merge: squad has invalid records.');
                return;
            }

            const duplicates = squad.members.filter(rec => isDuplicateCharacter(rec, rosterData));
            let strategy = 'keep-newest';
            if (duplicates.length > 0) {
                const choice = prompt(`Detected ${duplicates.length} duplicate(s) (player+character). Choose strategy: keep-newest | keep-local | keep-incoming | keep-both`, 'keep-newest');
                if (!choice) return;
                strategy = choice.trim();
                if (!['keep-newest','keep-local','keep-incoming','keep-both'].includes(strategy)) {
                    alert('Invalid strategy. Merge cancelled.');
                    return;
                }
            }

            const merged = [...rosterData];
            squad.members.forEach(rec => {
                const idx = merged.findIndex(r => r.playerName.toLowerCase() === rec.playerName.toLowerCase() && r.characterName.toLowerCase() === rec.characterName.toLowerCase());
                if (idx === -1) {
                    merged.push(rec);
                } else {
                    if (strategy === 'keep-local') return;
                    if (strategy === 'keep-incoming') { merged[idx] = rec; return; }
                    if (strategy === 'keep-both') { merged.push(rec); return; }
                    if (strategy === 'keep-newest') {
                        const localDate = Date.parse(merged[idx].addedDate || 0) || 0;
                        const incomingDate = Date.parse(rec.addedDate || 0) || Date.now();
                        if (incomingDate >= localDate) merged[idx] = rec;
                    }
                }
            });

            if (confirm(`Merge "${squad.name}" (${squad.members.length} members) using strategy "${strategy}"?`)) {
                rosterData.length = 0;
                rosterData.push(...merged);
                saveRoster();
                renderRoster();
                updateTeamBoons();
                alert(`${squad.members.length} members processed with strategy ${strategy}.`);
                document.getElementById('squadsModal').style.display = 'none';
            }
        }

        // Delete Squad
        function deleteSquad(squadId) {
            const squad = squadsData.find(s => s.id === squadId);
            if (!squad) return;

            if (confirm(`Delete squad "${squad.name}"?`)) {
                const index = squadsData.findIndex(s => s.id === squadId);
                if (index > -1) {
                    squadsData.splice(index, 1);
                    saveSquads();
                    renderSquadsList();
                }
            }
        }

        // Utility functions
        function calculateBoons(members) {
            const counts = {};
            const providers = {};
            
            members.forEach(member => {
                const classSpec = member.classSpec;
                if (boonsByClass[classSpec]) {
                    boonsByClass[classSpec].forEach(boon => {
                        if (!counts[boon]) {
                            counts[boon] = 0;
                            providers[boon] = [];
                        }
                        counts[boon]++;
                        providers[boon].push(member.characterName);
                    });
                }
            });
            return { counts, providers };
        }

        function downloadJson(data, filename) {
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Filters and sorting handlers
        document.getElementById('applyFiltersBtn').addEventListener('click', () => {
            filterState = {
                search: (document.getElementById('filterSearch').value || '').toLowerCase(),
                role: document.getElementById('filterRole').value,
                gear: document.getElementById('filterGear').value,
                tag: (document.getElementById('filterTag').value || '').toLowerCase()
            };
            renderRoster();
        });

        document.getElementById('clearFiltersBtn').addEventListener('click', () => {
            document.getElementById('filterSearch').value = '';
            document.getElementById('filterRole').value = '';
            document.getElementById('filterGear').value = '';
            document.getElementById('filterTag').value = '';
            filterState = { search: '', role: '', gear: '', tag: '' };
            renderRoster();
        });

        document.getElementById('sortField').addEventListener('change', (e) => {
            sortState.field = e.target.value;
            renderRoster();
        });

        document.getElementById('sortDirectionBtn').addEventListener('click', () => {
            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            document.getElementById('sortDirectionBtn').textContent = sortState.direction === 'asc' ? 'Asc' : 'Desc';
            renderRoster();
        });

        document.getElementById('saveRoleTargetsBtn').addEventListener('click', () => {
            const inputs = document.querySelectorAll('[data-role-target]');
            inputs.forEach(input => {
                const role = input.getAttribute('data-role-target');
                const val = Math.max(0, Number(input.value || 0));
                roleTargets[role] = val;
                input.value = val;
            });
            saveRoleTargets();
            updateRoleTargetsStatus();
            alert('Role targets saved');
        });

        document.getElementById('applyRolePresetBtn').addEventListener('click', () => {
            const presetKey = document.getElementById('rolePresetSelect').value;
            if (!presetKey || !rolePresets[presetKey]) {
                alert('Select a preset first.');
                return;
            }
            const preset = rolePresets[presetKey].targets;
            allowedRoles.forEach(role => {
                roleTargets[role] = preset[role] ?? 0;
            });
            saveRoleTargets();
            renderRoleTargetsUI();
            updateRoleTargetsStatus();
            alert(`Applied preset: ${rolePresets[presetKey].label}`);
        });

        document.getElementById('clearRolePresetBtn').addEventListener('click', () => {
            allowedRoles.forEach(role => {
                roleTargets[role] = 0;
            });
            saveRoleTargets();
            renderRoleTargetsUI();
            updateRoleTargetsStatus();
            document.getElementById('rolePresetSelect').value = '';
        });

        // Initial render
        renderRoleTargetsUI();
        populateBoonSelect();
        populateBoonFilterSelect();
        renderRoster();
        updateTeamBoons();
        updateSubgroupAnalysis();
    </script>
</body>
</html>
